/***********************************************************************/
/*  FILE        :initial.c                                             */
/*  DATE        :Mar, 2014                                             */
/*  Programmer	:xiang 'R                                              */
/*  CPU TYPE    :STM8S003     Crystal: 4M HSI                          */
/*  DESCRIPTION :                                                      */
/*  Mark        :ver 1.0                                               */
/***********************************************************************/
//#include "stm8s.h"
#include  <iostm8s003f3.h>
#include "Pin_define.h"		// 管脚定义
#include "initial.h"		// 初始化  预定义
#include "ram.h"		// RAM定义


void RAM_clean(void)      // 清除RAM 
{			
  asm("ldw X,#0");
  asm("clear_ram:");
  asm("clr (X)");
  asm("incw X");
  asm("cpw X,#0x3f0");	
  asm("jrule clear_ram");
}  

void SysClock_Init( void )
{ 				// 系统时钟（外部时钟）
//	CLK_ICKR_HSIEN = 1;						// 使能内部RC OSC
//	CLK_ECKR_HSEEN = 1;						// 打开外部晶振 
//	while(( CLK_ECKR & 0x02 ) == 0 );		// 检查外部晶振 
//	CLK_SWR = 0xb4;							// 指定HSE为主时钟 
//	while(( CLK_SWCR & 0x08 ) == 0 );		// 等待外部晶振 
//	CLK_SWCR_SWEN = 1;						// 执行切换
//	CLK_CKDIVR = 0x00;						// 设置时钟分频（不分频）
//	//---------------------------------------- 外设
//	CLK_PCKENR1 = 0xF6;						// T1~4,UART1,SPI
//	CLK_PCKENR2 = 0x08;						// ADC

	
	CLK_ICKR_HSIEN = 1;				// 使能内部RC OSC（16.00MHz）
	while(( CLK_ICKR & 0x02 ) == 0 );		// 检查内部晶振 
	CLK_SWR = 0xE1;					// 指定HSI为主时钟 
//	while(( CLK_SWCR & 0x08 ) == 0 );		// 等待HSI切换 
	CLK_SWCR_SWEN = 1;						// 执行切换
	CLK_CKDIVR = 0x10;		// 设置时钟分频  f HSI= f HSI RC输出/4    f CPU= f MASTER
	//---------------------------------------- 外设  
	//CLK_PCKENR1 = 0x84;						// T1,UART1
//	CLK_PCKENR1 = 0x14;						// T4,UART1
//	CLK_PCKENR2 = 0x08;						// ADC	
	
	CLK_ICKR_LSIEN = 1;				// 使能内部LSI OSC（128KHz）
	while(CLK_ICKR_LSIRDY == 0 );		// 检查内部LSI OSC 
}

void beep_init( void )
{ 	
     //BEEP_CSR=0x4E; 
  BEEP_CSR=0;
  BEEP_CSR_BEEPDIV=14;
  BEEP_CSR_BEEPSEL=1; 
}
/****************端口设置说明***************************
CR1寄存器  输出 Output（1=推挽、0=OC）
           输入 Input（1=上拉、0=浮动）
***************end************************************/
void VHF_GPIO_INIT(void)   // CPU端口设置
{
 /* ADF7012 register interface */  
  ADF7021_SCLK_direc = Output;   
  ADF7021_SCLK_CR1 = 1;	
  ADF7021_SCLK=0;
  
  ADF7021_SDATA_direc = Output;
  ADF7021_SDATA_CR1 = 1;
  ADF7021_SDATA=0;
  
  ADF7021_SLE_direc = Output;
  ADF7021_SLE_CR1 = 1;  
  ADF7021_SLE=0;
  
  ADF7021_POWER_direc = Output;
  ADF7021_POWER_CR1 = 1; 
  ADF7021_POWER=0;
//  ADF7021_CE_direc = Output;
//  ADF7021_CE_CR1 = 1; 
  
  
/* Other ADF7021 connections */
  ADF7021_DATA_tx_direc = Output; // Output   调制DATA线
  ADF7021_DATA_tx_CR1 = 1;
  ADF7021_DATA_tx=0;
  
  ADF7021_DATA_CLK_direc= Input;
  ADF7021_DATA_CLK_CR1= 1;

  PIN_KEY_OPEN_direc = Input; 	// 输入  OPEN键
  PIN_KEY_OPEN_CR1 = 1;
  
  PIN_KEY_STOP_direc = Input;    // 输入  STOP键
  PIN_KEY_STOP_CR1 = 1;
  
  PIN_KEY_CLOSE_direc = Input;   // 输入  CLOSE键
  PIN_KEY_CLOSE_CR1 = 1;
  
  PIN_KEY_LOGIN_direc = Input;   // 输入  LOGIN键
  PIN_KEY_LOGIN_CR1 = 1;

  PIN_LED_direc = Output;     // Output   LED灯
  PIN_LED_CR1 = 1;

  PIN_BEEP_direc = Output;    // Output   蜂鸣器
  PIN_BEEP_CR1 = 1;
  PIN_BEEP=0;
  
  PIN_POWER_CONTROL_direc = Output;    // Output   电源控制
  PIN_POWER_CONTROL_CR1 = 1;
  PIN_POWER_CONTROL=0;
  
  PIN_test_mode_direc=Input;    // 输入     test脚
  PIN_test_mode_CR1=1;
  
  PIN_POWER_AD_direc = Input;     // 输入     电源监测AD脚 

}


//===================Delayus()延时===============//
void Delayus(unsigned char timer)
{
unsigned char x;                   //延时T=(timer-1)*1.5+3 us
 for(x=0;x<timer;x++)
     __asm("nop");
}